Задачи:

1. Класс соединения с ретрайми +
2. Брать сразу объектов станций +
3. Нормализация баз данных - +
4. Широту и долготу перенести в Station +
5. Убрать избыточный Daily performance report +
6. ООП StationQueryService (описывать методы которые работают с только БД только стации) +
7. ООП WeatherDataHttpClient(методы которые будут делать запросы в API, dependency injection паттерн) +
9. Класс Exception кастомный. Ловим эксепшены в одном месте. Один блок try-except Остается проблема с http errors, parsing errors.
они ловятся, но не факт, что в базе будет легко найти место и причину. +/- 
10. Заменить pytz на zoneinfo +
11. Sleep убрать, убийство для процессора +
12. earliest/latest report time, сохранять в StationRequestResult? +
13. написать метод обновления координат всех станций, перед опросом. +
14. Добавить аутентификацию и авторизацию полльзователей по токену, добавлять новых может только админ. +
15. Обновлять Celery Beat с помощью админки +


17. Логика парсинга ответов от API. +
  a. Если значение соответствует ожидаемому типу данных Python - преобразовать и сохранить.
  b. Если значение присутствует в соотв. парсинговой модели - сохранить код явления, а если же не найдено - отчеты станции не сохраняются., а в модель добавляется новая запись для присвоения кода. В StationRequestResult сохраняется результат запроса к станции со статусом UNKNOWN_PARSING_VALUE.
  c. Если пришло null(под любым ключем) - сохранить null.
  d. Если пришел неизвестный ключ(KeyError, маловероятный случай) или произошла ошибка при преобразовании значения в нужный тип данных Python(ValueError, TypeError) - отчеты этой станции за предыдущие сутки не сохраняются, в базу мониторинга вностися статус PARSING_ERROR.


18. Логика работы с исключениями
    а. При опросе станций все исключения ловятся для следующих методов:
       - WeatherDataService.save_retrospective_weather() +
       - StationHttpService.get_stations_current_weather(), StationQueryService.update_stations() только в рамках выполнения save_retrospective_weather().
       - WeatherDataService.fetch_current_weather() -
    b. Информация об исключениях в базе
      - Сообщение с о том, какой именно HTTP_REQUEST_ERROR сохранять в базу. -

19. База данных и модели
    а. Ограничения
      - Добавить UniqueConstraint по value_api во все парсинговые модели. +
        При POST и создании записи - value_api(*обязательно), при PUT code(*обязательно) +
      - Добавить UniqueConstraint [station, unix] в WeatherData +
      - Сохранять src в json. -
  

19. weatherdata_api
  - Ручка получения данных по ID станции get-weather-data/: Починить фильтрацию по datetime +
  - Нет смысла в wind_scale_8, поскольку могут придти как названия направлений(Север, Юг, ...), так и любое значение в градусах 0-359. Соответственно многие значения просто не могут быть преобразованы в wind_scale_8. Оставить только wind_degree +
  - Ручка текущей погоды(парсинг). Сериализацию сделать аналогично как для get-weather-data/ +
  - Ручка для результатов опроса станций с фильтрацией +

20. Фунционал
    a. Повторный опрос станций в случае, если пришли неизвестные названия явлений при первичном опросе. -
    - Добавить медот повторного опроса в tasks.py -
    - Скоректировать логику save_retrospective_weather() чтобы опрашивать только станции выдавшие UNKNOWN_PARSING_VALUE. -
    - В StationRequestResult менять статус на SUCCESS если повторный запрос прошел успешно. -
    ! После первого опроса, неизвестные литовские значения API сохранятются в базу и, если не присвоить им коды, то при повторном опросе
    в поля WeatherData так и запишутся null !

  
21. Мониторинг
    a. Подключение системы мониторинга Prometheus -

22. Логгирование
    а. Вывести логгирование в Sentry/Prometheus или Graphna. -

Обновления
I. precipitation_type приведены в соотв. с таблицей Леонида https://meteofor.atlassian.net/wiki/spaces/METEO/pages/5048580
surface_cond приведены к табличке Евгения, файл Surface_conditions.png в папке synop_code_refernces.
II. Структура возвращаемого JSON изменена с соотв. с просбой Филиппа: {result:[{},{},{}], count: int, status: str}.
В модель Station добавлены height(подтягивается из внешнего источника), position_change_counter, position_change_time для отслеживания перемещения станции.
III. убать ID фильтр в ручке архивных, старт энд дельта не больше часа , 206 204 для неверных данных по архивной ручке
V. Для ручки get-weather-data/ фильтрация возможна как с ID станции, так и без. Временной промежуток остается обязательнам параметром.


График генерации отчетов станциями

1. Станции с периодичностью отчетов 10 мин:
00:00:40
00:10:00
00:20:00
00:30:00
00:40:00
00:50:00

2. Станции с периодичностью отчетов 15 мин:
00:10:40
00:25:00
00:40:00
00:55:00

важный момент! чтобы забрать по 1 отчету за срок со всех станций за предыдущий час одним запросом, и чтобы например отчет попал в *:50 по *:00, делаем такой запрос: https://blackwaterpark.ddns.net/api/v1/get-weather-data/?start=2025-01-28T01:50&end=2025-01-28T02:00



